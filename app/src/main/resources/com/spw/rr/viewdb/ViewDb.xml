<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spw.rr.viewdb.ViewDb">
    <select id="listDecodersByRosterID" resultType="DecoderEntry">
        SELECT
            p.id,
            p.decoderId,
            p.fileName,
            p.roadNumber,
            p.roadName,
            p.manufacturer,
            p.owner,
            p.model,
            p.dccAddress,
            p.manufacturerId,
            p.productId,
            p.dateUpdated,
            p.decoderTypeId,
            p.detailTime,
            p.rosterId,
            COALESCE(hasSpeedProfile, '-') as hasSpeedProfile,
            COALESCE(hasDetail, '-') as hasDetail
        FROM decoder p
            LEFT OUTER JOIN
        ( SELECT
            'Yes' AS hasSpeedProfile,
            t1.Id
        FROM
        decoder t1
        WHERE
            EXISTS ( SELECT * FROM speedprofile sp
        WHERE
            sp.decoderid = t1.id)) AS t11
        ON p.id = t11.id
        LEFT OUTER JOIN
            ( SELECT
                'Yes' AS hasdetail,
                t1.id
            FROM
                decoder t1
            WHERE
                EXISTS ( SELECT * FROM cvvalues cv
                WHERE cv.decoderid = t1.id)
                OR EXISTS ( SELECT * FROM decoderdef de
                    WHERE de.decoderid = t1.id)) AS t21
        ON t21.id = p.id
        <where>
            <foreach collection="list" index="index" item="item"
                     open="rosterid IN (" separator="," close=")">
                #{item}
            </foreach>
        </where>
        ORDER BY id
    </select>
    <select id="ListWithCvs" resultMap="decoderMap">
        SELECT
        b.id,
        b.decoderid,
        a.dccAddress,
        a.roadName as roadName,
        a.roadNumber as roadNumber,
        cvNumber as cvNumber,
        cvValue as cvValue
        FROM
        decoder a
        INNER JOIN
        cvvalues b
        ON a.id = b.decoderid
        <where>
            <foreach collection="arg0" index="index" item="item"
                     open = "b.decoderid IN (" separator="," close=")">
                #{item}
            </foreach>
        <if test="arg1 == null &amp; !arg2">
        AND cvNumber IN ('1',
        '2',
        '3',
        '4',
        '5' ,
        '6',
        '7',
        '8',
        '9',
        '10',
        '11',
        '12',
        '13',
        '14',
        '15',
        '16',
        '17',
        '18',
        '19')
        ORDER BY
        b.decoderid,
        cvNumber
        </if>
        <if test="arg1 != null">
            <foreach collection="arg1" index="index" item="item"
                     open="AND cvNumber IN (" separator="," close=")">
                #{item}
            </foreach>
        </if>
        </where>
    </select>
    <resultMap id="decoderMap" type="DecoderEntry">
        <id property="id" column="decoderId"/>
        <result property="roadName" column="roadName"/>
        <result property="roadNumber" column="roadNumber"/>
        <result property="dccAddress" column="dccAddress"/>
        <collection property="cvValues" ofType="CvValues">
            <id column="id" property="id"/>
            <result property="cvNumber" column="cvNumber"/>
            <result property="cvValue" column="cvValue"/>
        </collection>
    </resultMap>
</mapper>